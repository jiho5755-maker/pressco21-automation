// 소기업 경영 자동화 시스템 — DB 스키마
// 로컬: SQLite, 프로덕션: PostgreSQL (Vercel Postgres)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────────
// Auth.js 호환 테이블 + RBAC
// ─────────────────────────────────────────────

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String // bcryptjs 해시
  role          String    @default("admin") // "admin"|"manager"|"viewer"

  accounts Account[]
  sessions Session[]

  submittedExpenses  Expense[]             @relation("ExpenseSubmitter")
  approvedExpenses   Expense[]             @relation("ExpenseApprover")
  approvedLeaves     LeaveRecord[]         @relation("LeaveApprover")
  submittedSubsidies SubsidyApplication[] @relation("SubsidySubmitter")
  approvedSubsidies  SubsidyApplication[] @relation("SubsidyApprover")

  // Phase 3: 문서/전자결재
  createdDocuments    Document[]   @relation("DocumentCreator")
  approvals           Approval[]
  uploadedAttachments Attachment[]

  // Phase 3-D: 알림 로그
  receivedNotifications NotificationLog[] @relation("NotificationRecipient")

  // Phase 5: 알림 시스템
  notificationPreference NotificationPreference? @relation("UserNotificationPreference")
  webNotifications       Notification[]          @relation("UserNotifications")

  employee Employee? // 1:1 관계 (직원 중 일부만 로그인 계정 보유)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}

// ─────────────────────────────────────────────
// 부서
// ─────────────────────────────────────────────

model Department {
  id        String  @id @default(cuid())
  name      String  @unique
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  employees Employee[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─────────────────────────────────────────────
// 직원 — 인사노무 + 유연근무 + 대체인력 통합
// ─────────────────────────────────────────────

model Employee {
  id         String  @id @default(cuid())
  employeeNo String  @unique // 사번 (EMP001)
  name       String
  email      String?
  phone      String?

  // ── 인증 계정 연결 (선택적, 1:1 관계) ──
  userId String? @unique // 로그인 계정 ID (manager/viewer 역할 직원만 설정)
  user   User?   @relation(fields: [userId], references: [id])

  // ── 인적사항 추가 ──
  birthDate       DateTime? // 생년월일 (나이 기반 지원금 차등 적용용)
  address         String? // 주소
  childrenUnder20 Int     @default(0) // 20세 이하 자녀 수 (자녀세액공제 계산용)

  // ── 소속 ──
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])
  position     String // "사원"|"주임"|"대리"|"과장"|"차장"|"부장"|"이사"

  // ── 계약 정보 ──
  joinDate        DateTime // 입사일 (연차 기산점)
  contractType    String    @default("REGULAR") // "REGULAR"|"CONTRACT"|"PARTTIME"|"REPLACEMENT"
  contractEndDate DateTime? // 계약직/대체인력 종료일
  probationEnd    DateTime? // 수습 종료일

  // ── 대체인력 관계 (self-reference) ──
  replacementForId  String?
  replacementFor    Employee?  @relation("ReplacementRelation", fields: [replacementForId], references: [id])
  replacements      Employee[] @relation("ReplacementRelation")
  replacementReason String? // "MATERNITY"|"PARENTAL"|"SICK"

  // ── 근무 조건 (기본) ──
  weeklyWorkHours Int    @default(40) // 소정근로시간(주당)
  workStartTime   String @default("09:00") // 기본 출근시간 HH:mm
  workEndTime     String @default("18:00") // 기본 퇴근시간 HH:mm
  breakMinutes    Int    @default(60) // 휴게시간(분)

  // ── 유연근무 설정 ──
  workType       String  @default("OFFICE") // "OFFICE"|"FLEXIBLE_HOURS"|"REMOTE"|"HYBRID"
  flexStartTime  String? // 시차출퇴근 출근시간
  flexEndTime    String? // 시차출퇴근 퇴근시간
  remoteWorkDays String? // 재택근무 요일 JSON: "[\"MON\",\"WED\"]"

  // ── 급여 정보 ──
  salaryType String @default("MONTHLY") // "MONTHLY"|"HOURLY"
  baseSalary Int    @default(0) // 기본급(원) — 의미 변경: 총급여 → 기본급

  // ── 수당 필드 ──
  mealAllowance      Int @default(0) // 식대(원)
  transportAllowance Int @default(0) // 교통비(원)
  positionAllowance  Int @default(0) // 직책수당(원)

  // ── 비과세 여부 ──
  taxFreeMeal      Boolean @default(true) // 식대 비과세 여부
  taxFreeTransport Boolean @default(true) // 교통비 비과세 여부

  // ── 포괄임금(고정OT) 설정 ──
  useFixedOT                Boolean @default(false) // 고정OT 사용 여부
  fixedOTHours              Int? // 월 고정 연장근로 시간 (예: 20시간)
  fixedOTAmount             Int? // 월 고정 연장수당 금액 (원)
  fixedNightWorkHours       Int?    @default(0) // 월 고정 야간근로 시간
  fixedNightWorkAmount      Int?    @default(0) // 월 고정 야간수당 금액
  fixedHolidayWorkHours     Int?    @default(0) // 월 고정 휴일근로 시간
  fixedHolidayWorkAmount    Int?    @default(0) // 월 고정 휴일수당 금액
  fixedOTAgreementConfirmed Boolean @default(false) // 서면 합의 확인 여부 (법적 필수)

  bankName    String?
  bankAccount String?

  // ── 4대보험 ──
  nationalPension     Boolean @default(true)
  healthInsurance     Boolean @default(true)
  employmentInsurance Boolean @default(true)
  industrialAccident  Boolean @default(true)
  dependents          Int     @default(1) // 부양가족 수

  // ── 상태 관리 ──
  status         String    @default("ACTIVE") // "ACTIVE"|"ON_LEAVE"|"RESIGNED"
  leaveType      String? // "MATERNITY"|"PARENTAL"|"SICK"|"PERSONAL"|"SPOUSE_MATERNITY"
  leaveStartDate DateTime?
  leaveEndDate   DateTime?
  resignDate     DateTime?
  resignReason   String?

  // ── 관계 ──
  expenses                   Expense[]
  attendanceRecords          AttendanceRecord[]
  leaveRecords               LeaveRecord[]
  workSchedules              WorkSchedule[]
  payrollRecords             PayrollRecord[]
  subsidyApplications        SubsidyApplication[]
  replacementWorkerSubsidies SubsidyApplication[] @relation("ReplacementWorker")
  documents                  Document[] // Phase 3: 문서 관리

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─────────────────────────────────────────────
// 요일별 근무 스케줄 (시차출퇴근 핵심)
// ─────────────────────────────────────────────

model WorkSchedule {
  id         String   @id @default(cuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  dayOfWeek Int // 0(일)~6(토)
  startTime String // HH:mm
  endTime   String // HH:mm
  isRemote  Boolean @default(false) // 해당 요일 재택 여부
  isWorkDay Boolean @default(true) // 근무일 여부

  effectiveFrom DateTime // 적용 시작일
  effectiveTo   DateTime? // 적용 종료일 (null=현재 유효)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, dayOfWeek, effectiveFrom])
}

// ─────────────────────────────────────────────
// 출퇴근 기록 (정부 지원 핵심 증빙)
// ─────────────────────────────────────────────

model AttendanceRecord {
  id         String   @id @default(cuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  date        DateTime // 근무일
  clockIn     DateTime? // 실제 출근 시각
  clockOut    DateTime? // 실제 퇴근 시각
  workType    String    @default("OFFICE") // "OFFICE"|"REMOTE"|"FLEXIBLE_HOURS"|"HOLIDAY"|"LEAVE"
  workMinutes Int? // 실근로시간(분)
  overtime    Int       @default(0) // 연장근로(분)
  nightWork   Int       @default(0) // 야간근로(분) 22~06시
  note        String?

  // ── 휴일근로 관리 (Phase 1-D Task 2) ──
  isHolidayWork   Boolean   @default(false) // 휴일근로 여부
  holidayType     String? // "WEEKLY_REST"|"LEGAL_HOLIDAY"|"AGREED_HOLIDAY" (휴일 유형)
  holidayWorkHours Float?   @default(0) // 휴일근로 시간 (8시간 이내, × 1.5)
  holidayOvertimeHours Float? @default(0) // 휴일 초과근로 (8시간 초과, × 2.0 또는 × 1.5)

  // ── 휴일대체 관리 (근로기준법 제57조) ──
  isSubstitutedHoliday Boolean   @default(false) // 휴일대체 적용 여부
  originalHolidayDate  DateTime? // 원래 휴일 날짜 (휴일대체 시)
  substitutedDate      DateTime? // 대체된 근로일 날짜 (휴일대체 시)

  isConfirmed Boolean @default(false) // 관리자 확인 여부

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, date])
  @@index([employeeId, date]) // 직원별 날짜 조회 최적화
  @@index([date]) // 월별 집계 최적화
  @@index([isConfirmed]) // 미확정 기록 조회 최적화
  @@index([isHolidayWork]) // 휴일근로 조회 최적화
}

// ─────────────────────────────────────────────
// 휴가/휴직 이력 (출산+육아 추적)
// ─────────────────────────────────────────────

model LeaveRecord {
  id         String   @id @default(cuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // ── 휴가 기본 정보 ──
  type      String // "ANNUAL"|"MATERNITY"|"PARENTAL"|"SPOUSE_MATERNITY"|"SICK"|"PERSONAL"|"COMPENSATORY"
  startDate DateTime
  endDate   DateTime
  days      Float // 사용일수 (0.5 = 반차)

  // ── 반차 구분 (법적 요건) ──
  halfDayType String? // "AM"|"PM" (days=0.5일 때만 사용)

  // ── 결재 상태 및 이력 ──
  status      String   @default("PENDING") // "PENDING"|"APPROVED"|"REJECTED"|"CANCELLED"
  requestedAt DateTime @default(now()) // 신청 일시

  approvedBy String? // 승인자 userId
  approver   User?     @relation("LeaveApprover", fields: [approvedBy], references: [id], onDelete: SetNull)
  approvedAt DateTime? // 승인 일시

  rejectedReason String? // 반려 사유 (시기변경권 행사 시 필수)

  // ── 신청 사유 ──
  reason String?

  // ── 출산/육아 전용 필드 ──
  childBirthDate DateTime? // 자녀 출생일 (출산휴가/육아휴직 기간 자동계산용)

  // ── 감사 추적 ──
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ── 인덱스 ──
  @@index([employeeId, startDate]) // 직원별 기간 조회
  @@index([employeeId, status]) // 직원별 상태 필터링
  @@index([status, requestedAt]) // 대기 중인 신청 목록
  @@index([type, startDate]) // 휴가 유형별 통계
  @@index([startDate, endDate]) // 기간 범위 조회
}

// ─────────────────────────────────────────────
// 급여 대장 (월별 급여 확정 이력)
// ─────────────────────────────────────────────

model PayrollRecord {
  id         String   @id @default(cuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // 귀속 연월
  year  Int
  month Int

  // 급여 구성 (저장 시점 스냅샷)
  baseSalary         Int // 기본급
  mealAllowance      Int // 식대
  transportAllowance Int // 교통비
  positionAllowance  Int // 직책수당

  // 비과세 여부 (스냅샷)
  taxFreeMeal      Boolean @default(true)
  taxFreeTransport Boolean @default(true)

  // 고정OT (스냅샷)
  useFixedOT             Boolean @default(false)
  fixedOTAmount          Int     @default(0)
  fixedNightWorkAmount   Int     @default(0)
  fixedHolidayWorkAmount Int     @default(0)

  // 근태 기반 변동 수당 (계산값)
  variableOvertimeMinutes   Int @default(0) // 연장근로 총 분
  variableNightWorkMinutes  Int @default(0) // 야간근로 총 분
  variableHolidayMinutes    Int @default(0) // 휴일근로 총 분 (추후 구현)
  variableOvertimeAmount    Int @default(0) // 연장수당 금액
  variableNightWorkAmount   Int @default(0) // 야간수당 금액
  variableHolidayWorkAmount Int @default(0) // 휴일수당 금액

  // 계산 결과
  totalGross     Int // 총 급여
  totalTaxable   Int // 과세 대상
  totalInsurance Int // 4대보험료 합계
  incomeTax      Int // 소득세
  localIncomeTax Int // 지방소득세
  netSalary      Int // 실수령액

  // 4대보험 세부 (참고용)
  nationalPension     Int @default(0)
  healthInsurance     Int @default(0)
  longTermCare        Int @default(0)
  employmentInsurance Int @default(0)

  // 상태 관리
  isConfirmed Boolean   @default(false) // 급여 확정 여부
  confirmedAt DateTime? // 확정 시각
  confirmedBy String? // 확정자 userId

  // 감사
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, year, month], name: "employeeId_year_month")
  @@index([year, month])
  @@index([isConfirmed, year, month])
}

// ─────────────────────────────────────────────
// 경비
// ─────────────────────────────────────────────

model Expense {
  id          String   @id @default(cuid())
  title       String
  amount      Int
  category    String
  date        DateTime
  description String?

  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id])

  submitterId String
  submitter   User   @relation("ExpenseSubmitter", fields: [submitterId], references: [id])

  status       String    @default("PENDING") // "PENDING"|"APPROVED"|"REJECTED"
  approverId   String?
  approver     User?     @relation("ExpenseApprover", fields: [approverId], references: [id])
  approvedAt   DateTime?
  rejectReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─────────────────────────────────────────────
// 정부지원사업 신청 (Phase 2)
// ─────────────────────────────────────────────

model SubsidyApplication {
  id String @id @default(cuid())

  // ── 신청 기본 정보 ──
  type  String // "FLEXIBLE_WORK"|"REPLACEMENT_WORKER"|"PARENTAL_LEAVE_GRANT"|"WORK_SHARING"|"INFRA_SUPPORT"
  year  Int // 귀속 연도 (예: 2026)
  month Int // 귀속 월 (1~12)

  // ── 신청 대상 직원 ──
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // ── 신청 금액 ──
  requestedAmount Int // 신청 금액 (원)
  approvedAmount  Int? // 승인된 금액 (원) — 실제 지급액

  // ── 자격 검증 관련 필드 (유형별) ──
  // 유연근무: 월 사용 횟수
  flexibleWorkCount Int? // 해당 월 유연근무 사용 횟수 (최소 4회)

  // 대체인력: 대체인력 정보
  replacementEmployeeId String? // 대체인력 직원 ID
  replacementEmployee   Employee? @relation("ReplacementWorker", fields: [replacementEmployeeId], references: [id], onDelete: SetNull)
  replacementStartDate  DateTime? // 대체인력 근무 시작일
  replacementEndDate    DateTime? // 대체인력 근무 종료일

  // 육아휴직 부여: 자녀 정보
  childBirthDate        DateTime? // 자녀 출생일
  childAgeAtApplication Int? // 신청 시점 자녀 연령 (개월)

  // ── 출산육아 지원금 전용 필드 (Phase 3-D) ──
  // 출산전후휴가 급여: 휴가 기간
  maternityLeaveStartDate DateTime? // 출산휴가 시작일
  maternityLeaveEndDate   DateTime? // 출산휴가 종료일

  // 육아휴직 급여: 휴직 기간
  parentalLeaveStartDate DateTime? // 육아휴직 시작일
  parentalLeaveEndDate   DateTime? // 육아휴직 종료일

  // 육아기/임신기 근로시간 단축: 단축 시간
  shortenedHoursPerWeek Int? // 단축 시간 (주당, 시간 단위)

  // ── 결재 상태 ──
  status String @default("PENDING") // "PENDING"|"APPROVED"|"REJECTED"|"PAID"

  // ── 신청자 ──
  submitterId String
  submitter   User     @relation("SubsidySubmitter", fields: [submitterId], references: [id])
  submittedAt DateTime @default(now())

  // ── 승인자 ──
  approverId String?
  approver   User?     @relation("SubsidyApprover", fields: [approverId], references: [id], onDelete: SetNull)
  approvedAt DateTime?

  // ── 지급 정보 ──
  paidAt DateTime? // 지급 완료 시각
  paidBy String? // 지급 처리자 userId

  // ── 반려 사유 ──
  rejectReason String?

  // ── 메모/비고 ──
  note String?

  // ── 감사 추적 ──
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ── 인덱스 ──
  @@unique([employeeId, type, year, month]) // 중복 신청 방지
  @@index([employeeId, year, month]) // 직원별 월별 조회
  @@index([type, status]) // 유형별 상태 필터링
  @@index([status, submittedAt]) // 대기 중인 신청 목록
  @@index([year, month, status]) // 월별 통계
}

// ─────────────────────────────────────────────
// 문서 관리 (Phase 3: 행정/문서/전자결재)
// ─────────────────────────────────────────────

model Document {
  id String @id @default(cuid())

  // ── 문서 기본 정보 ──
  title String // "근로계약서", "임금명세서", "공지사항" 등
  type  String // "EMPLOYMENT_CONTRACT"|"PAYSLIP"|"RESIGNATION"|"NOTICE"|"OTHER"

  // ── 문서 상태 ──
  status String @default("DRAFT") // "DRAFT"|"PENDING_APPROVAL"|"APPROVED"|"REJECTED"|"ISSUED"|"ARCHIVED"

  // ── 문서 대상 직원 ──
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // ── 문서 작성자 ──
  createdBy String
  creator   User   @relation("DocumentCreator", fields: [createdBy], references: [id])

  // ── 문서 컨텐츠 ──
  content  String // JSON 저장 (근로계약서 추가 필드, 임금명세서 내용 등)
  template String? // 템플릿 ID (EMPLOYMENT_CONTRACT_V1 등)

  // ── 버전 관리 (자기참조) ──
  previousVersionId String?
  previousVersion   Document?  @relation("DocumentVersions", fields: [previousVersionId], references: [id], onDelete: SetNull)
  nextVersions      Document[] @relation("DocumentVersions")
  versionNumber     Int        @default(1)

  // ── 관계 ──
  approvals   Approval[]
  attachments Attachment[]

  // ── 법정 정보 ──
  issuedAt    DateTime? // 발급일
  effectiveAt DateTime? // 발효일

  // ── 감사 추적 ──
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ── 인덱스 ──
  @@index([employeeId, type]) // 직원별 문서 유형 조회
  @@index([status]) // 상태별 필터링
  @@index([type, createdAt]) // 문서 유형별 시간순
  @@index([createdBy, status]) // 작성자별 상태 필터링
}

// ─────────────────────────────────────────────
// 전자결재 라인 (복수 승인자 순차 결재)
// ─────────────────────────────────────────────

model Approval {
  id String @id @default(cuid())

  // ── 결재 대상 문서 ──
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // ── 결재자 ──
  approverId String
  approver   User   @relation(fields: [approverId], references: [id], onDelete: Cascade)

  // ── 결재 순서 (순차 결재) ──
  approvalOrder Int // 1, 2, 3, ...

  // ── 결재 상태 ──
  status String @default("PENDING") // "PENDING"|"APPROVED"|"REJECTED"|"SKIPPED"

  // ── 결재 의견 ──
  comment String?

  // ── 결재 시각 ──
  approvedAt DateTime?
  rejectedAt DateTime?

  // ── 감사 추적 ──
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ── 인덱스 및 제약 ──
  @@unique([documentId, approverId, approvalOrder]) // 중복 결재 방지
  @@index([documentId, status]) // 문서별 결재 상태
  @@index([approverId, status]) // 결재자별 대기 목록
  @@index([documentId, approvalOrder, status]) // 순차 결재 조회
}

// ─────────────────────────────────────────────
// 문서 첨부파일
// ─────────────────────────────────────────────

model Attachment {
  id String @id @default(cuid())

  // ── 문서 연결 ──
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // ── 파일 정보 ──
  fileName String
  fileSize Int // 바이트
  mimeType String // "application/pdf", "image/jpeg", etc.
  fileUrl  String // Vercel Blob URL 또는 로컬 경로

  // ── 메타데이터 ──
  description String?
  uploadedBy  String
  uploader    User   @relation(fields: [uploadedBy], references: [id])

  // ── 감사 추적 ──
  createdAt DateTime @default(now())

  // ── 인덱스 ──
  @@index([documentId]) // 문서별 첨부파일 조회
}

// ─────────────────────────────────────────────
// 알림 로그 (Phase 3-D: 이메일 발송 이력)
// ─────────────────────────────────────────────

model NotificationLog {
  id String @id @default(cuid())

  // ── 알림 유형 ──
  type String // "APPROVAL_REQUEST"|"DOCUMENT_APPROVED"|"DOCUMENT_REJECTED"|"PAYSLIP_READY"|"SUBSIDY_APPROVED"|"LEAVE_APPROVED"|"SYSTEM"

  // ── 수신자 ──
  recipientId    String
  recipient      User   @relation("NotificationRecipient", fields: [recipientId], references: [id], onDelete: Cascade)
  recipientEmail String // 발송 시점 이메일 (User 삭제 시 이력 보존용)

  // ── 이메일 제목 및 본문 ──
  subject  String
  htmlBody String // HTML 본문
  textBody String? // 플레인 텍스트 본문 (선택)

  // ── 발송 결과 ──
  success   Boolean // 발송 성공 여부
  emailId   String? // Resend 이메일 ID (재발송/추적용)
  errorCode String? // 실패 시 에러 코드 (RATE_LIMIT, INVALID_EMAIL 등)
  errorMessage String? // 실패 시 에러 메시지

  // ── 발송 일시 ──
  sentAt DateTime @default(now())

  // ── 관련 엔티티 (선택) ──
  relatedDocumentId  String? // 관련 문서 ID
  relatedPayrollId   String? // 관련 급여 ID
  relatedSubsidyId   String? // 관련 지원금 ID
  relatedLeaveId     String? // 관련 휴가 ID

  // ── 메타데이터 ──
  metadata String? // JSON 저장 (추가 정보)

  // ── 감사 추적 ──
  createdAt DateTime @default(now())

  // ── 인덱스 ──
  @@index([recipientId, type]) // 수신자별 유형 조회
  @@index([recipientId, sentAt]) // 수신자별 시간순 조회
  @@index([type, sentAt]) // 유형별 통계
  @@index([success, sentAt]) // 실패 건 조회
  @@index([emailId]) // Resend 이메일 ID 조회
}

// ─────────────────────────────────────────────
// 웹 알림 (Phase 5: 알림 시스템 고도화)
// ─────────────────────────────────────────────

model Notification {
  id String @id @default(cuid())

  // ── 수신자 (User 삭제 시 SetNull, 스냅샷 보존) ──
  recipientId    String?
  recipient      User?   @relation("UserNotifications", fields: [recipientId], references: [id], onDelete: SetNull)
  recipientName  String // User.name 스냅샷 (감사 로그용)
  recipientEmail String // User.email 스냅샷 (감사 로그용)

  // ── 알림 내용 ──
  type    String // "APPROVAL_REQUEST"|"DOCUMENT_APPROVED"|"DOCUMENT_REJECTED"|"PAYSLIP_READY"|"SUBSIDY_APPROVED"|"LEAVE_APPROVED"|"EXPENSE_APPROVED"|"ATTENDANCE_CONFIRMED"|"ANNUAL_LEAVE_LOW"|"CONTRACT_EXPIRING"|"PROBATION_ENDING"|"SYSTEM"
  title   String
  message String

  // ── Polymorphic 관계 (관련 엔티티) ──
  relatedEntityType String? // "Document"|"PayrollRecord"|"SubsidyApplication"|"LeaveRecord"|"Expense"|"AttendanceRecord"
  relatedEntityId   String? // 엔티티의 실제 ID (FK 제약 없음)

  // ── 액션 URL ──
  actionUrl String? // 클릭 시 이동 경로 (예: /documents/abc123)

  // ── 읽음 상태 ──
  isRead Boolean   @default(false)
  readAt DateTime?

  // ── 감사 추적 ──
  createdAt DateTime @default(now())
  // updatedAt은 불필요 (알림 생성 후 수정 없음, isRead/readAt만 변경)

  // ── 인덱스 ──
  @@index([recipientId, isRead, createdAt]) // 미읽음 알림 조회 (정렬 포함)
  @@index([recipientId, createdAt]) // 최신 알림 조회 (읽음 여부 무관)
  @@index([type, createdAt]) // 유형별 통계 (관리자용)
  @@index([relatedEntityType, relatedEntityId]) // 역방향 조회 (엔티티 삭제 시 알림 정리)
}

// ─────────────────────────────────────────────
// 알림 설정 (사용자별 채널/유형 설정)
// ─────────────────────────────────────────────

model NotificationPreference {
  id String @id @default(cuid())

  userId String @unique
  user   User   @relation("UserNotificationPreference", fields: [userId], references: [id], onDelete: Cascade)

  // ── 채널별 전역 설정 ──
  emailEnabled Boolean @default(true) // 이메일 알림 전체 활성화
  webEnabled   Boolean @default(true) // 웹 알림 전체 활성화

  // ── 유형별 세부 설정 (1:N 관계) ──
  typePreferences NotificationTypePreference[]

  // ── 감사 추적 ──
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model NotificationTypePreference {
  id String @id @default(cuid())

  preferenceId String
  preference   NotificationPreference @relation(fields: [preferenceId], references: [id], onDelete: Cascade)

  // ── 알림 유형 ──
  type String // "APPROVAL_REQUEST"|"DOCUMENT_APPROVED"|... (Notification.type과 동일)

  // ── 채널별 활성화 ──
  emailEnabled Boolean @default(true)
  webEnabled   Boolean @default(true)

  // ── 감사 추적 ──
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ── 제약 및 인덱스 ──
  @@unique([preferenceId, type]) // 중복 설정 방지
  @@index([preferenceId]) // 설정 조회 최적화
}
