// 소기업 경영 자동화 시스템 — DB 스키마
// 로컬: SQLite, 프로덕션: PostgreSQL (Vercel Postgres)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────────
// Auth.js 호환 테이블 + RBAC
// ─────────────────────────────────────────────

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String // bcryptjs 해시
  role          String    @default("admin") // "admin"|"manager"|"viewer"

  accounts Account[]
  sessions Session[]

  submittedExpenses Expense[]     @relation("ExpenseSubmitter")
  approvedExpenses  Expense[]     @relation("ExpenseApprover")
  approvedLeaves    LeaveRecord[] @relation("LeaveApprover")

  employee Employee? // 1:1 관계 (직원 중 일부만 로그인 계정 보유)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}

// ─────────────────────────────────────────────
// 부서
// ─────────────────────────────────────────────

model Department {
  id        String  @id @default(cuid())
  name      String  @unique
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  employees Employee[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─────────────────────────────────────────────
// 직원 — 인사노무 + 유연근무 + 대체인력 통합
// ─────────────────────────────────────────────

model Employee {
  id         String  @id @default(cuid())
  employeeNo String  @unique // 사번 (EMP001)
  name       String
  email      String?
  phone      String?

  // ── 인증 계정 연결 (선택적, 1:1 관계) ──
  userId String? @unique // 로그인 계정 ID (manager/viewer 역할 직원만 설정)
  user   User?   @relation(fields: [userId], references: [id])

  // ── 인적사항 추가 ──
  address         String? // 주소
  childrenUnder20 Int     @default(0) // 20세 이하 자녀 수 (자녀세액공제 계산용)

  // ── 소속 ──
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])
  position     String // "사원"|"주임"|"대리"|"과장"|"차장"|"부장"|"이사"

  // ── 계약 정보 ──
  joinDate        DateTime // 입사일 (연차 기산점)
  contractType    String    @default("REGULAR") // "REGULAR"|"CONTRACT"|"PARTTIME"|"REPLACEMENT"
  contractEndDate DateTime? // 계약직/대체인력 종료일
  probationEnd    DateTime? // 수습 종료일

  // ── 대체인력 관계 (self-reference) ──
  replacementForId  String?
  replacementFor    Employee?  @relation("ReplacementRelation", fields: [replacementForId], references: [id])
  replacements      Employee[] @relation("ReplacementRelation")
  replacementReason String? // "MATERNITY"|"PARENTAL"|"SICK"

  // ── 근무 조건 (기본) ──
  weeklyWorkHours Int    @default(40) // 소정근로시간(주당)
  workStartTime   String @default("09:00") // 기본 출근시간 HH:mm
  workEndTime     String @default("18:00") // 기본 퇴근시간 HH:mm
  breakMinutes    Int    @default(60) // 휴게시간(분)

  // ── 유연근무 설정 ──
  workType       String  @default("OFFICE") // "OFFICE"|"FLEXIBLE_HOURS"|"REMOTE"|"HYBRID"
  flexStartTime  String? // 시차출퇴근 출근시간
  flexEndTime    String? // 시차출퇴근 퇴근시간
  remoteWorkDays String? // 재택근무 요일 JSON: "[\"MON\",\"WED\"]"

  // ── 급여 정보 ──
  salaryType String @default("MONTHLY") // "MONTHLY"|"HOURLY"
  baseSalary Int    @default(0) // 기본급(원) — 의미 변경: 총급여 → 기본급

  // ── 수당 필드 ──
  mealAllowance      Int @default(0) // 식대(원)
  transportAllowance Int @default(0) // 교통비(원)
  positionAllowance  Int @default(0) // 직책수당(원)

  // ── 비과세 여부 ──
  taxFreeMeal      Boolean @default(true) // 식대 비과세 여부
  taxFreeTransport Boolean @default(true) // 교통비 비과세 여부

  // ── 포괄임금(고정OT) 설정 ──
  useFixedOT                Boolean @default(false) // 고정OT 사용 여부
  fixedOTHours              Int? // 월 고정 연장근로 시간 (예: 20시간)
  fixedOTAmount             Int? // 월 고정 연장수당 금액 (원)
  fixedNightWorkHours       Int?    @default(0) // 월 고정 야간근로 시간
  fixedNightWorkAmount      Int?    @default(0) // 월 고정 야간수당 금액
  fixedHolidayWorkHours     Int?    @default(0) // 월 고정 휴일근로 시간
  fixedHolidayWorkAmount    Int?    @default(0) // 월 고정 휴일수당 금액
  fixedOTAgreementConfirmed Boolean @default(false) // 서면 합의 확인 여부 (법적 필수)

  bankName    String?
  bankAccount String?

  // ── 4대보험 ──
  nationalPension     Boolean @default(true)
  healthInsurance     Boolean @default(true)
  employmentInsurance Boolean @default(true)
  industrialAccident  Boolean @default(true)
  dependents          Int     @default(1) // 부양가족 수

  // ── 상태 관리 ──
  status         String    @default("ACTIVE") // "ACTIVE"|"ON_LEAVE"|"RESIGNED"
  leaveType      String? // "MATERNITY"|"PARENTAL"|"SICK"|"PERSONAL"|"SPOUSE_MATERNITY"
  leaveStartDate DateTime?
  leaveEndDate   DateTime?
  resignDate     DateTime?
  resignReason   String?

  // ── 관계 ──
  expenses          Expense[]
  attendanceRecords AttendanceRecord[]
  leaveRecords      LeaveRecord[]
  workSchedules     WorkSchedule[]
  payrollRecords    PayrollRecord[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─────────────────────────────────────────────
// 요일별 근무 스케줄 (시차출퇴근 핵심)
// ─────────────────────────────────────────────

model WorkSchedule {
  id         String   @id @default(cuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  dayOfWeek Int // 0(일)~6(토)
  startTime String // HH:mm
  endTime   String // HH:mm
  isRemote  Boolean @default(false) // 해당 요일 재택 여부
  isWorkDay Boolean @default(true) // 근무일 여부

  effectiveFrom DateTime // 적용 시작일
  effectiveTo   DateTime? // 적용 종료일 (null=현재 유효)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, dayOfWeek, effectiveFrom])
}

// ─────────────────────────────────────────────
// 출퇴근 기록 (정부 지원 핵심 증빙)
// ─────────────────────────────────────────────

model AttendanceRecord {
  id         String   @id @default(cuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  date        DateTime // 근무일
  clockIn     DateTime? // 실제 출근 시각
  clockOut    DateTime? // 실제 퇴근 시각
  workType    String    @default("OFFICE") // "OFFICE"|"REMOTE"|"FLEXIBLE_HOURS"|"HOLIDAY"|"LEAVE"
  workMinutes Int? // 실근로시간(분)
  overtime    Int       @default(0) // 연장근로(분)
  nightWork   Int       @default(0) // 야간근로(분) 22~06시
  note        String?

  isConfirmed Boolean @default(false) // 관리자 확인 여부

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, date])
  @@index([employeeId, date]) // 직원별 날짜 조회 최적화
  @@index([date]) // 월별 집계 최적화
  @@index([isConfirmed]) // 미확정 기록 조회 최적화
}

// ─────────────────────────────────────────────
// 휴가/휴직 이력 (출산+육아 추적)
// ─────────────────────────────────────────────

model LeaveRecord {
  id         String   @id @default(cuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // ── 휴가 기본 정보 ──
  type      String // "ANNUAL"|"MATERNITY"|"PARENTAL"|"SPOUSE_MATERNITY"|"SICK"|"PERSONAL"|"COMPENSATORY"
  startDate DateTime
  endDate   DateTime
  days      Float // 사용일수 (0.5 = 반차)

  // ── 반차 구분 (법적 요건) ──
  halfDayType String? // "AM"|"PM" (days=0.5일 때만 사용)

  // ── 결재 상태 및 이력 ──
  status      String   @default("PENDING") // "PENDING"|"APPROVED"|"REJECTED"|"CANCELLED"
  requestedAt DateTime @default(now()) // 신청 일시

  approvedBy String? // 승인자 userId
  approver   User?     @relation("LeaveApprover", fields: [approvedBy], references: [id], onDelete: SetNull)
  approvedAt DateTime? // 승인 일시

  rejectedReason String? // 반려 사유 (시기변경권 행사 시 필수)

  // ── 신청 사유 ──
  reason String?

  // ── 출산/육아 전용 필드 ──
  childBirthDate DateTime? // 자녀 출생일 (출산휴가/육아휴직 기간 자동계산용)

  // ── 감사 추적 ──
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ── 인덱스 ──
  @@index([employeeId, startDate]) // 직원별 기간 조회
  @@index([employeeId, status]) // 직원별 상태 필터링
  @@index([status, requestedAt]) // 대기 중인 신청 목록
  @@index([type, startDate]) // 휴가 유형별 통계
  @@index([startDate, endDate]) // 기간 범위 조회
}

// ─────────────────────────────────────────────
// 급여 대장 (월별 급여 확정 이력)
// ─────────────────────────────────────────────

model PayrollRecord {
  id         String   @id @default(cuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // 귀속 연월
  year  Int
  month Int

  // 급여 구성 (저장 시점 스냅샷)
  baseSalary         Int // 기본급
  mealAllowance      Int // 식대
  transportAllowance Int // 교통비
  positionAllowance  Int // 직책수당

  // 비과세 여부 (스냅샷)
  taxFreeMeal      Boolean @default(true)
  taxFreeTransport Boolean @default(true)

  // 고정OT (스냅샷)
  useFixedOT             Boolean @default(false)
  fixedOTAmount          Int     @default(0)
  fixedNightWorkAmount   Int     @default(0)
  fixedHolidayWorkAmount Int     @default(0)

  // 근태 기반 변동 수당 (계산값)
  variableOvertimeMinutes   Int @default(0) // 연장근로 총 분
  variableNightWorkMinutes  Int @default(0) // 야간근로 총 분
  variableHolidayMinutes    Int @default(0) // 휴일근로 총 분 (추후 구현)
  variableOvertimeAmount    Int @default(0) // 연장수당 금액
  variableNightWorkAmount   Int @default(0) // 야간수당 금액
  variableHolidayWorkAmount Int @default(0) // 휴일수당 금액

  // 계산 결과
  totalGross     Int // 총 급여
  totalTaxable   Int // 과세 대상
  totalInsurance Int // 4대보험료 합계
  incomeTax      Int // 소득세
  localIncomeTax Int // 지방소득세
  netSalary      Int // 실수령액

  // 4대보험 세부 (참고용)
  nationalPension     Int @default(0)
  healthInsurance     Int @default(0)
  longTermCare        Int @default(0)
  employmentInsurance Int @default(0)

  // 상태 관리
  isConfirmed Boolean   @default(false) // 급여 확정 여부
  confirmedAt DateTime? // 확정 시각
  confirmedBy String? // 확정자 userId

  // 감사
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, year, month], name: "employeeId_year_month")
  @@index([year, month])
  @@index([isConfirmed, year, month])
}

// ─────────────────────────────────────────────
// 경비
// ─────────────────────────────────────────────

model Expense {
  id          String   @id @default(cuid())
  title       String
  amount      Int
  category    String
  date        DateTime
  description String?

  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id])

  submitterId String
  submitter   User   @relation("ExpenseSubmitter", fields: [submitterId], references: [id])

  status       String    @default("PENDING") // "PENDING"|"APPROVED"|"REJECTED"
  approverId   String?
  approver     User?     @relation("ExpenseApprover", fields: [approverId], references: [id])
  approvedAt   DateTime?
  rejectReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
